<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.267">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Building Spatial Datasets - Spatial operations with the sf, tigris, and crashapi packages</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Building Spatial Datasets - Spatial operations with the sf, tigris, and crashapi packages">
<meta property="og:description" content="This exercise is designed to be used as an interactive activity to better understand how to work with spatial transformation functions from the sf package. A few suggestions:">
<meta property="og:image" content="https://elipousson.github.io/bldgspatialdata/files/img/ges600-logo.png">
<meta property="og:site-name" content="Building Spatial Datasets">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1254">
<meta property="og:image:width" content="1180">
<meta name="twitter:title" content="Building Spatial Datasets - Spatial operations with the sf, tigris, and crashapi packages">
<meta name="twitter:description" content="This exercise is designed to be used as an interactive activity to better understand how to work with spatial transformation functions from the sf package. A few suggestions:">
<meta name="twitter:image" content="https://elipousson.github.io/bldgspatialdata/files/img/ges600-logo.png">
<meta name="twitter:creator" content="\@elipousson">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1254">
<meta name="twitter:image-width" content="1180">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Building Spatial Datasets</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html">
 <span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../schedule.html">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../assignments/index.html">
 <span class="menu-text">Assignments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../materials.html">
 <span class="menu-text">Materials</span></a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#getting-started" id="toc-getting-started" class="nav-link active" data-scroll-target="#getting-started">Getting started</a>
  <ul class="collapse">
<li><a href="#loading-packages" id="toc-loading-packages" class="nav-link" data-scroll-target="#loading-packages">Loading packages</a></li>
  <li><a href="#downloading-data" id="toc-downloading-data" class="nav-link" data-scroll-target="#downloading-data">Downloading data</a></li>
  <li><a href="#mapping-data" id="toc-mapping-data" class="nav-link" data-scroll-target="#mapping-data">Mapping data</a></li>
  </ul>
</li>
  <li>
<a href="#geometry-operations" id="toc-geometry-operations" class="nav-link" data-scroll-target="#geometry-operations">Geometry operations</a>
  <ul class="collapse">
<li><a href="#cropping-and-transforming-data" id="toc-cropping-and-transforming-data" class="nav-link" data-scroll-target="#cropping-and-transforming-data">Cropping and transforming data</a></li>
  <li><a href="#getting-the-intersection-or-difference-between-pairs-of-simple-features" id="toc-getting-the-intersection-or-difference-between-pairs-of-simple-features" class="nav-link" data-scroll-target="#getting-the-intersection-or-difference-between-pairs-of-simple-features">Getting the intersection or difference between pairs of simple features</a></li>
  </ul>
</li>
  <li><a href="#geometric-operations" id="toc-geometric-operations" class="nav-link" data-scroll-target="#geometric-operations">Geometric operations</a></li>
  <li><a href="#confirming-geometric-relationships" id="toc-confirming-geometric-relationships" class="nav-link" data-scroll-target="#confirming-geometric-relationships">Confirming geometric relationships</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Spatial operations with the sf, tigris, and crashapi packages</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">example</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>This exercise is designed to be used as an interactive activity to better understand how to work with spatial transformation functions from the sf package. A few suggestions:</p>
<ul>
<li><p>Questions that require you to figure out a function call before continuing are marked with a 🤔 emoji.</p></li>
<li><p>Try not to skip ahead because the answers to earlier questions are sometimes revealed by code later in the document. 😉</p></li>
<li><p>If you get stuck, explore the {sf} package documentation or take a look at the <a href="https://github.com/rstudio/cheatsheets/blob/main/sf.pdf">{sf} cheatsheet</a> (This exercise also organizes the functions using the same categories as the cheatsheet).</p></li>
<li><p>If you are submitting a completed exercise for the course, please make sure to check that the document renders without errors before committing an updated file to your course repository. 💪🏼</p></li>
</ul>
<section id="getting-started" class="level2"><h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<section id="loading-packages" class="level3"><h3 class="anchored" data-anchor-id="loading-packages">Loading packages</h3>
<p>First we need to load a few packages:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="downloading-data" class="level3"><h3 class="anchored" data-anchor-id="downloading-data">Downloading data</h3>
<p>Then, we can download the counties with <code><a href="https://rdrr.io/pkg/tigris/man/counties.html">tigris::counties()</a></code> and then filter to those counties in the <a href="https://en.wikipedia.org/wiki/Baltimore_metropolitan_area">Baltimore–Columbia–Towson Metropolitan Statistical Area</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set the state abbreviation</span></span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="st">"MD"</span></span>
<span></span>
<span><span class="co"># Get the counties with tigris::counties()</span></span>
<span><span class="va">md_counties</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">md</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># FIPS codes for the counties in the Baltimore MSA</span></span>
<span><span class="va">msa_fips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"510"</span>, <span class="st">"005"</span>, <span class="st">"013"</span>, <span class="st">"003"</span>, <span class="st">"027"</span>, <span class="st">"035"</span>, <span class="st">"025"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter to the counties in the Baltimore MSA</span></span>
<span><span class="va">msa_counties</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">md_counties</span>,</span>
<span>    <span class="va">COUNTYFP</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">msa_fips</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I also want data on U.S. highways. We won’t use this data right away but we’ll need it later on in this exercise.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">us_highways</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/primary_roads.html">primary_roads</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2020</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, I can use the <a href="https://en.wikipedia.org/wiki/FIPS_county_code">county FIPS code</a> column from <code>msa</code> (named <code>COUNTYFP</code>) to get crash data using the <a href="https://elipousson.github.io/crashapi/">{crashapi}</a> package and the National Highway Traffic Safety Administration (NHTSA) <a href="https://crashviewer.nhtsa.dot.gov/CrashAPI/">Fatality Analysis Reporting System (FARS) API</a>.</p>
<p>Below, I am using <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map_dfr()</a></code> allows us to combine results for each county into a single data frame. When <code>geometry = TRUE</code>, <code><a href="https://elipousson.github.io/crashapi/reference/get_fars.html">crashapi::get_fars_crashes()</a></code> is using <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">sf::st_as_sf()</a></code> to convert a data frame into a sf object based on the longitude and latitude columns.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_crashes</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span></span>
<span>    <span class="va">md_counties</span><span class="op">$</span><span class="va">COUNTYFP</span>,</span>
<span>    <span class="op">~</span> <span class="fu">crashapi</span><span class="fu">::</span><span class="fu"><a href="https://elipousson.github.io/crashapi/reference/get_fars.html">get_fars_crashes</a></span><span class="op">(</span></span>
<span>      year <span class="op">=</span> <span class="fl">2020</span>,</span>
<span>      state <span class="op">=</span> <span class="va">md</span>,</span>
<span>      county <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">msa_crashes</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">md_crashes</span>,</span>
<span>    <span class="va">county</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">msa_fips</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-tip callout callout-style-simple">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>If you’re interested in learning more using API packages, check out Ch. 8 <a href="https://geocompr.robinlovelace.net/read-write.html">Geographic data I/O</a> in <span class="citation" data-cites="lovelaceGeocomputation2022">Lovelace, Nowosad, and Muenchow (<a href="#ref-lovelaceGeocomputation2022" role="doc-biblioref">2022</a>)</span>. For more on the advanced topic of developing API packages, check out <a href="https://httr2.r-lib.org/articles/wrapping-apis.html">this vignette from the {httr2} package</a> (which is what {crashapi} is using to download data from NHTSA).</p>
</div>
</div>
</div>
</section><section id="mapping-data" class="level3"><h3 class="anchored" data-anchor-id="mapping-data">Mapping data</h3>
<p>For this exercise, we are using the {tmap} package to take a look at the data. Visual checks are often essential to exploring and understanding what the spatial and geometric transformation functions are doing to your data. Similar to ggplot2 plots, you can put the results of a map into an object that you can use as a base map.</p>
<div class="cell">
<details><summary><strong>Show the code</strong> | Map Baltimore MSA boundaries</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_borders</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">md_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"gray60"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">msa_borders</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">msa_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"gray60"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">msa_borders</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">msa_crashes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="co">## Warning in sf::st_is_longlat(shp2): bounding box has potentially an invalid</span></span>
<span><span class="co">## value range for longlat data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="06_spatial-operations-r-crashapi_files/figure-html/tmap_crashes-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Wait a moment: did you see spot the warning up there? 👆🏼 It said: “Warning in sf::st_is_longlat(shp2): bounding box has potentially an invalid value range for longlat data.”</p>
<p>Where is that coming from? Let’s take a quick look at the data using the base <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">msa_crashes</span><span class="op">)</span></span>
<span><span class="co">##      city             cityname            county           countyname       </span></span>
<span><span class="co">##  Length:229         Length:229         Length:229         Length:229        </span></span>
<span><span class="co">##  Class :character   Class :character   Class :character   Class :character  </span></span>
<span><span class="co">##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  </span></span>
<span><span class="co">##                                                                             </span></span>
<span><span class="co">##                                                                             </span></span>
<span><span class="co">##                                                                             </span></span>
<span><span class="co">##    case_year        fatals         latitude         longitud      </span></span>
<span><span class="co">##  Min.   :2020   Min.   :1.000   Min.   : 38.73   Min.   : -77.17  </span></span>
<span><span class="co">##  1st Qu.:2020   1st Qu.:1.000   1st Qu.: 39.20   1st Qu.: -76.75  </span></span>
<span><span class="co">##  Median :2020   Median :1.000   Median : 39.30   Median : -76.63  </span></span>
<span><span class="co">##  Mean   :2020   Mean   :1.061   Mean   : 39.73   Mean   : -68.20  </span></span>
<span><span class="co">##  3rd Qu.:2020   3rd Qu.:1.000   3rd Qu.: 39.37   3rd Qu.: -76.53  </span></span>
<span><span class="co">##  Max.   :2020   Max.   :3.000   Max.   :100.00   Max.   :1000.00  </span></span>
<span><span class="co">##     state            statename           st_case          totalvehicles  </span></span>
<span><span class="co">##  Length:229         Length:229         Length:229         Min.   :1.000  </span></span>
<span><span class="co">##  Class :character   Class :character   Class :character   1st Qu.:1.000  </span></span>
<span><span class="co">##  Mode  :character   Mode  :character   Mode  :character   Median :1.000  </span></span>
<span><span class="co">##                                                           Mean   :1.629  </span></span>
<span><span class="co">##                                                           3rd Qu.:2.000  </span></span>
<span><span class="co">##                                                           Max.   :8.000  </span></span>
<span><span class="co">##    tway_id            tway_id2            ve_forms             geometry  </span></span>
<span><span class="co">##  Length:229         Length:229         Min.   :1.00   POINT        :229  </span></span>
<span><span class="co">##  Class :character   Class :character   1st Qu.:1.00   epsg:4326    :  0  </span></span>
<span><span class="co">##  Mode  :character   Mode  :character   Median :1.00   +proj=long...:  0  </span></span>
<span><span class="co">##                                        Mean   :1.52                      </span></span>
<span><span class="co">##                                        3rd Qu.:2.00                      </span></span>
<span><span class="co">##                                        Max.   :5.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>☝️ Hint: look at the range of the latitude and longitude columns.</p>
<p>Did you spot the issue? I can use filter to track down the problem:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">msa_crashes</span>,</span>
<span>  <span class="va">longitud</span> <span class="op">&gt;</span> <span class="fl">180</span> <span class="op">|</span> <span class="va">latitude</span> <span class="op">&gt;</span> <span class="fl">90</span> <span class="op">|</span> <span class="va">longitud</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">180</span> <span class="op">|</span> <span class="va">latitude</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">90</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Warning in st_is_longlat(x): bounding box has potentially an invalid value range</span></span>
<span><span class="co">## for longlat data</span></span>
<span><span class="co">## # A tibble: 2 × 16</span></span>
<span><span class="co">##   city  cityname  county countyname case_…¹ fatals latit…² longi…³ state state…⁴</span></span>
<span><span class="co">##   &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;        &lt;int&gt;  &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  </span></span>
<span><span class="co">## 1 50    BALTIMORE 510    BALTIMORE…    2020      1   100.    1000. 24    Maryla…</span></span>
<span><span class="co">## 2 50    BALTIMORE 510    BALTIMORE…    2020      1    77.8    778. 24    Maryla…</span></span>
<span><span class="co">## # … with 6 more variables: st_case &lt;chr&gt;, totalvehicles &lt;int&gt;, tway_id &lt;chr&gt;,</span></span>
<span><span class="co">## #   tway_id2 &lt;chr&gt;, ve_forms &lt;int&gt;, geometry &lt;POINT [°]&gt;, and abbreviated</span></span>
<span><span class="co">## #   variable names ¹​case_year, ²​latitude, ³​longitud, ⁴​statename</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To fix this issue, we need to crop the data to exclude outlying invalid coordinates. Cropping is one of a few geometry operations supported by the sf package. Let’s dig in.</p>
</section></section><section id="geometry-operations" class="level2"><h2 class="anchored" data-anchor-id="geometry-operations">Geometry operations</h2>
<section id="cropping-and-transforming-data" class="level3"><h3 class="anchored" data-anchor-id="cropping-and-transforming-data">Cropping and transforming data</h3>
<p>How can I use <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop()</a></code> to exclude those incorrectly located crashes? <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop()</a></code> takes two parameters:</p>
<ul>
<li>
<code>x</code>: A <code>sf</code> or <code>sfc</code> object that you want to <em>crop</em>
</li>
<li>
<code>y</code>: A <code>sf</code>, <code>sfc</code>, or <code>bbox</code> object (or numeric x and y min/max values) that you want to crop <em>to</em>
</li>
</ul>
<p>This pattern of an <code>x</code> and <code>y</code> parameter is common across all the geometry operations although, for at least some, the second parameter is optional.</p>
<p>🤔 What parameters do you need to crop <code>msa_crashes</code>?</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># msa_crashes &lt;- st_crop()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Oops. Did you get an error?</p>
<p>Here is the catch: both objects need to use the same coordinate reference system for spatial transformation functions to work. To do this we need to know what coordinate reference system <code>msa_crashes</code> is using.</p>
<p>You can use <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code> to check:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">msa_crashes</span><span class="op">)</span></span>
<span><span class="co">## Coordinate Reference System:</span></span>
<span><span class="co">##   User input: EPSG:4326 </span></span>
<span><span class="co">##   wkt:</span></span>
<span><span class="co">## GEOGCRS["WGS 84",</span></span>
<span><span class="co">##     ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span><span class="co">##         MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span><span class="co">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span><span class="co">##             LENGTHUNIT["metre",1]],</span></span>
<span><span class="co">##         ENSEMBLEACCURACY[2.0]],</span></span>
<span><span class="co">##     PRIMEM["Greenwich",0,</span></span>
<span><span class="co">##         ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span><span class="co">##     CS[ellipsoidal,2],</span></span>
<span><span class="co">##         AXIS["geodetic latitude (Lat)",north,</span></span>
<span><span class="co">##             ORDER[1],</span></span>
<span><span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span><span class="co">##         AXIS["geodetic longitude (Lon)",east,</span></span>
<span><span class="co">##             ORDER[2],</span></span>
<span><span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span><span class="co">##     USAGE[</span></span>
<span><span class="co">##         SCOPE["Horizontal component of 3D system."],</span></span>
<span><span class="co">##         AREA["World."],</span></span>
<span><span class="co">##         BBOX[-90,-180,90,180]],</span></span>
<span><span class="co">##     ID["EPSG",4326]]</span></span>
<span></span>
<span><span class="co"># You can also use st_crs() to get a Spatial Reference identifier (srid) for a coordinate reference system</span></span>
<span><span class="co"># st_crs(msa_crashes)$srid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we need to use the <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> function to change to coordinate reference system of <code>msa_counties</code>. The first parameter of <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> is always the sf or sfc object to transform but the second parameter can be a number, a character, or the output from the <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code> function. For example, both of these calls transform <code>msa_counties</code> to the <a href="https://epsg.io/3857">Pseudo-Mercator</a> coordinate reference system used by Google Maps, OpenStreetMap, and other web maps:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">msa_counties</span>, <span class="fl">3857</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">msa_counties</span>, <span class="st">"EPSG:3857"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>🤔 Now it is your turn to transform <code>msa_counties</code>. Fill in the missing parameters:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># msa_counties &lt;- st_transform()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, you can crop <code>msa_crashes</code> the way you wanted:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Overwrite msa_crashes w/ cropped data</span></span>
<span><span class="va">msa_crashes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">msa_crashes</span>, <span class="va">msa_counties</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>OK. Let’s map the cropped <code>msa_crashes</code> data:</p>
<div class="cell">
<details><summary><strong>Show the code</strong> | Map crashes in the Baltimore metro area</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msa_borders</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">msa_crashes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="co">## Warning in sf::st_is_longlat(shp2): bounding box has potentially an invalid</span></span>
<span><span class="co">## value range for longlat data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="06_spatial-operations-r-crashapi_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Take a moment and compare this map with a map of <code>md_crashes</code> (which also needs to be cropped). Remember, tmap uses the bounding box of the first sf object passed to <code><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape()</a></code> to set the plot area.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">md_counties</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">md_crashes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Crop md_crashes also</span></span>
<span><span class="va">md_crashes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">md_crashes</span>, <span class="va">md_counties</span><span class="op">)</span></span>
<span></span>
<span><span class="va">msa_borders</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">md_crashes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_spatial-operations-r-crashapi_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Do you notice the difference between the two maps?</p>
<p>Imagine we didn’t have couldn’t use a county attribute to filter <code>msa_crashes</code> from <code>md_crashes</code>. How could we get data that is more like the first map?</p>
</section><section id="getting-the-intersection-or-difference-between-pairs-of-simple-features" class="level3"><h3 class="anchored" data-anchor-id="getting-the-intersection-or-difference-between-pairs-of-simple-features">Getting the intersection or difference between pairs of simple features</h3>
<p>Let’s try out <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection()</a></code>. Like <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop()</a></code>, this function takes two parameters but works a more like a cookie cutter—trimming the features of the first parameter to the boundary of the second parameter.</p>
<p>For example, I can trim <code>md_crashes</code> to the boundary of Baltimore City.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">md_counties</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">md_crashes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">msa_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">msa_counties</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">md_crashes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baltimore_city</span> <span class="op">&lt;-</span> <span class="va">msa_counties</span><span class="op">[</span><span class="fl">7</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">baltimore_crashes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">md_crashes</span>, <span class="va">baltimore_city</span><span class="op">)</span></span>
<span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout all</span></span>
<span><span class="co">## geometries</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function did a little more than just exclude the crashes outside Baltimore City. The names and attributes for any intersecting features from the second parameter have been joined to the features from the first parameter. You can actually get the same result using the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join()</a></code> function when <code>left = FALSE</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">baltimore_crashes_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">md_crashes</span>, <span class="va">baltimore_city</span>, left <span class="op">=</span> <span class="cn">FALSE</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># all.equal tests if two objects are (nearly) equal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">baltimore_crashes</span>, <span class="va">baltimore_crashes_join</span><span class="op">)</span></span>
<span><span class="co">## [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_difference()</a></code> works more like an eraser—selectively removing a specific area.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">crashes_outside_baltimore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_difference</a></span><span class="op">(</span><span class="va">md_crashes</span>, <span class="va">baltimore_city</span><span class="op">)</span></span>
<span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout all</span></span>
<span><span class="co">## geometries</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I can map the data to take a look at the results:</p>
<div class="cell">
<details><summary><strong>Show the code</strong> | Map crashes in and outside of Baltimore city</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msa_borders</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">baltimore_crashes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">crashes_outside_baltimore</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="06_spatial-operations-r-crashapi_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>🤔 Now, your turn. Can you use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection()</a></code> to trim the crash data to Anne Arundel County?</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># anne_arundel_crashes &lt;-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>🤔 Can you map the Anne Arundel County crashes over top of a crash map for the full state?</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># md_borders +</span></span>
<span><span class="co">#   tm_shape(anne_arundel_crashes) +</span></span>
<span><span class="co">#   tm_dots()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>🤔 Bonus question: can you figure out how many fatalities occurred in Anne Arundel County? Remember, the number of fatalities may not be the same as fatal crashes. Try using the <code><a href="https://rdrr.io/r/base/nrow.html">nrow()</a></code> and <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> functions to determine these numbers.</p>
<div class="cell">

</div>
<p>If you the intersection worked as expected, you should find <strong>50 crashes</strong> and <strong>50 fatalities</strong>.</p>
</section></section><section id="geometric-operations" class="level2"><h2 class="anchored" data-anchor-id="geometric-operations">Geometric operations</h2>
<p>OK. Let’s try something different. Remember those highways? The data covers the entire U.S. but we just need the highways for Maryland.</p>
<p>This time, I’ll use the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter()</a></code> function with the default <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects()</a></code> predicate (we will come back to predicate functions at the end):</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">us_highways</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">us_highways</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">md_crashes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">md_highways</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a></span><span class="op">(</span><span class="va">us_highways</span>, <span class="va">md_counties</span>, .predicate <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As usual, a map is helpful to make sure this worked the way I expected:</p>
<div class="cell">
<details><summary><strong>Show the code</strong> | Map Maryland Highways</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_borders</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">md_highways</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html">tm_lines</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="06_spatial-operations-r-crashapi_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now that we have highways, could we use <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter()</a></code> to get highway crashes? Give it a try:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a></span><span class="op">(</span><span class="va">md_crashes</span>, <span class="va">md_highways</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 0 × 16</span></span>
<span><span class="co">## # … with 16 variables: city &lt;chr&gt;, cityname &lt;chr&gt;, county &lt;chr&gt;,</span></span>
<span><span class="co">## #   countyname &lt;chr&gt;, case_year &lt;int&gt;, fatals &lt;int&gt;, latitude &lt;dbl&gt;,</span></span>
<span><span class="co">## #   longitud &lt;dbl&gt;, state &lt;chr&gt;, statename &lt;chr&gt;, st_case &lt;chr&gt;,</span></span>
<span><span class="co">## #   totalvehicles &lt;int&gt;, tway_id &lt;chr&gt;, tway_id2 &lt;chr&gt;, ve_forms &lt;int&gt;,</span></span>
<span><span class="co">## #   geometry &lt;GEOMETRY [°]&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Well, that didn’t work. The highways are a LINESTRING feature so it isn’t the most effective spatial filter. Using <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer()</a></code> we can add a little space around each highway and try again.</p>
<p>How does <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer()</a></code> work? Using the <code>dist</code> (short dor distance) parameter you can add space around a point, linestring, or polygon.</p>
<div class="callout-important callout callout-style-simple">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>This can get a little complicated depending on your coordinate reference system. When using the <a href="https://libgeos.org/">GEOS library</a>, the units for <code>dist</code> are degrees for geometric coordinate reference systems (e.g.&nbsp;EPSG:4326) or the system’s native units (most often feet or meters) for projected coordinate reference systems. But, when you are using the <a href="https://s2geometry.io/">s2geometry library</a>, <code>dist</code> is passed to the <code><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html">s2::s2_buffer_cells()</a></code> function where the units are determined by the units used by the <code>radius</code> parameter (which defaults to meters). It can be helpful to use the <code><a href="https://rdrr.io/pkg/units/man/units.html">units::set_units()</a></code> function that makes it easier to set the buffer in whatever distance you like and then convert to the needed units.</p>
</div>
</div>
</div>
<p>For this exercise, let’s convert our data projected CRS so we can use the version of <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer()</a></code> that works with GEOS.</p>
<div class="cell">
<details><summary><strong>Show the code</strong> | Transform data to a projected CRS</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_crashes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">md_crashes</span>, <span class="fl">3857</span><span class="op">)</span></span>
<span><span class="va">md_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">md_counties</span>, <span class="fl">3857</span><span class="op">)</span></span>
<span><span class="va">msa_crashes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">msa_crashes</span>, <span class="fl">3857</span><span class="op">)</span></span>
<span><span class="va">msa_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">msa_counties</span>, <span class="fl">3857</span><span class="op">)</span></span>
<span><span class="va">md_highways</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">md_highways</span>, <span class="fl">3857</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, I can add a buffer:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_highways_quartermi</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span></span>
<span>    <span class="va">md_highways</span>,</span>
<span>    dist <span class="op">=</span> <span class="fl">402.336</span> <span class="co"># quarter-mile in m</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">md_highways_halfmi</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span></span>
<span>    <span class="va">md_highways</span>,</span>
<span>    dist <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">set_units</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"mi"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">set_units</a></span><span class="op">(</span><span class="st">"m"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll map the data to show that it works (using Baltimore County to set the map bounding box so it easier to see the difference between the two buffers).</p>
<div class="cell">
<details><summary><strong>Show the code</strong> | Map bufferred Maryland highways</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">msa_counties</span>, bbox <span class="op">=</span> <span class="va">msa_counties</span><span class="op">[</span><span class="fl">7</span>, <span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"gray60"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">md_highways_quartermi</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">md_highways_halfmi</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"purple"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="06_spatial-operations-r-crashapi_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>🤔 A half mile buffer seems too large. Can you add a 250 meter buffer to the <code>md_highways</code>?</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># md_highways_250m &lt;- st_buffer()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, go back and filter crash data using <code>md_highways_250m</code>. How many fatal crashes took place within 250 meters of a highway in Maryland? How many fatalities?</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># st_filter()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You should find <strong>96 crashes</strong> and <strong>99 fatalities</strong>.</p>
</section><section id="confirming-geometric-relationships" class="level2"><h2 class="anchored" data-anchor-id="confirming-geometric-relationships">Confirming geometric relationships</h2>
<p>There is also a set of related functions called “predicates” or geometric confirmation functions that take pairs of simple feature geometry sets and return an index list or logical matrix based on the spatial relationship between the features. For example, take a look at <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">msa_counties</span>, <span class="va">md_counties</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">##       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10] [,11] [,12]</span></span>
<span><span class="co">## [1,]  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">## [2,] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">## [3,] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE</span></span>
<span><span class="co">## [4,] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">## [5,] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE</span></span>
<span><span class="co">## [6,] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE</span></span>
<span><span class="co">## [7,] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">##      [,13] [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24]</span></span>
<span><span class="co">## [1,] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">## [2,] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">## [3,] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">## [4,] FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">## [5,] FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">## [6,] FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">## [7,] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What is this matrix? The function is comparing each element of x (<code>msa_counties</code>) to each element of <code>y</code> (<code>md_counties</code>). We can simplify the function by using <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union()</a></code> on the second argument:</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">md_counties_union</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">md_counties</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">msa_counties</span>, <span class="va">md_counties_union</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">##      [,1]</span></span>
<span><span class="co">## [1,] TRUE</span></span>
<span><span class="co">## [2,] TRUE</span></span>
<span><span class="co">## [3,] TRUE</span></span>
<span><span class="co">## [4,] TRUE</span></span>
<span><span class="co">## [5,] TRUE</span></span>
<span><span class="co">## [6,] TRUE</span></span>
<span><span class="co">## [7,] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-lovelaceGeocomputation2022" class="csl-entry" role="doc-biblioentry">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2022. <em>Geocomputation with <span>R</span></em>. 2nd (WIP). <a href="https://geocompr.robinlovelace.net/">https://geocompr.robinlovelace.net/</a>.
</div>
</div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Spatial operations with the sf, tigris, and crashapi packages"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="an">knitr:</span><span class="co"> </span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">  opts_chunk: </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    collapse: true</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>This exercise is designed to be used as an interactive activity to better understand how to work with spatial transformation functions from the sf package. A few suggestions:</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Questions that require you to figure out a function call before continuing are marked with a 🤔 emoji.</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Try not to skip ahead because the answers to earlier questions are sometimes revealed by code later in the document. 😉</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>If you get stuck, explore the {sf} package documentation or take a look at the <span class="co">[</span><span class="ot">{sf} cheatsheet</span><span class="co">](https://github.com/rstudio/cheatsheets/blob/main/sf.pdf)</span> (This exercise also organizes the functions using the same categories as the cheatsheet).</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>If you are submitting a completed exercise for the course, please make sure to check that the document renders without errors before committing an updated file to your course repository. 💪🏼</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="fu">## Getting started</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading packages</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>First we need to load a few packages:</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="fu">### Downloading data</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>Then, we can download the counties with <span class="in">`tigris::counties()`</span> and then filter to those counties in the <span class="co">[</span><span class="ot">Baltimore--Columbia--Towson Metropolitan Statistical Area</span><span class="co">](https://en.wikipedia.org/wiki/Baltimore_metropolitan_area)</span>.</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r counties}</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the state abbreviation</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>md <span class="ot">&lt;-</span> <span class="st">"MD"</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the counties with tigris::counties()</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>md_counties <span class="ot">&lt;-</span> tigris<span class="sc">::</span><span class="fu">counties</span>(<span class="at">state =</span> md, <span class="at">cb =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="co"># FIPS codes for the counties in the Baltimore MSA</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>msa_fips <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"510"</span>, <span class="st">"005"</span>, <span class="st">"013"</span>, <span class="st">"003"</span>, <span class="st">"027"</span>, <span class="st">"035"</span>, <span class="st">"025"</span>)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to the counties in the Baltimore MSA</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>msa_counties <span class="ot">&lt;-</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    md_counties,</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    COUNTYFP <span class="sc">%in%</span> msa_fips</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>I also want data on U.S. highways. We won't use this data right away but we'll need it later on in this exercise.</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>us_highways <span class="ot">&lt;-</span> tigris<span class="sc">::</span><span class="fu">primary_roads</span>(<span class="at">year =</span> <span class="dv">2020</span>)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>Now, I can use the <span class="co">[</span><span class="ot">county FIPS code</span><span class="co">](https://en.wikipedia.org/wiki/FIPS_county_code)</span> column from <span class="in">`msa`</span> (named <span class="in">`COUNTYFP`</span>) to get crash data using the <span class="co">[</span><span class="ot">{crashapi}</span><span class="co">](https://elipousson.github.io/crashapi/)</span> package and the National Highway Traffic Safety Administration (NHTSA) <span class="co">[</span><span class="ot">Fatality Analysis Reporting System (FARS) API</span><span class="co">](https://crashviewer.nhtsa.dot.gov/CrashAPI/)</span>.</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>Below, I am using <span class="in">`purrr::map_dfr()`</span> allows us to combine results for each county into a single data frame. When <span class="in">`geometry = TRUE`</span>, <span class="in">`crashapi::get_fars_crashes()`</span> is using <span class="in">`sf::st_as_sf()`</span> to convert a data frame into a sf object based on the longitude and latitude columns.</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_fars_crashes}</span></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>md_crashes <span class="ot">&lt;-</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map_dfr</span>(</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>    md_counties<span class="sc">$</span>COUNTYFP,</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> crashapi<span class="sc">::</span><span class="fu">get_fars_crashes</span>(</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">year =</span> <span class="dv">2020</span>,</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">state =</span> md,</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">county =</span> .x,</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">geometry =</span> <span class="cn">TRUE</span></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>msa_crashes <span class="ot">&lt;-</span></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>    md_crashes,</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>    county <span class="sc">%in%</span> <span class="fu">as.integer</span>(msa_fips)</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple"}</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>If you're interested in learning more using API packages, check out Ch. 8 <span class="co">[</span><span class="ot">Geographic data I/O</span><span class="co">](https://geocompr.robinlovelace.net/read-write.html)</span> in @lovelaceGeocomputation2022. For more on the advanced topic of developing API packages, check out <span class="co">[</span><span class="ot">this vignette from the {httr2} package</span><span class="co">](https://httr2.r-lib.org/articles/wrapping-apis.html)</span> (which is what {crashapi} is using to download data from NHTSA).</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mapping data</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>For this exercise, we are using the {tmap} package to take a look at the data. Visual checks are often essential to exploring and understanding what the spatial and geometric transformation functions are doing to your data. Similar to ggplot2 plots, you can put the results of a map into an object that you can use as a base map.</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tmap_crashes}</span></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Map Baltimore MSA boundaries"</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>md_borders <span class="ot">&lt;-</span></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(md_counties) <span class="sc">+</span></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"gray60"</span>)</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>msa_borders <span class="ot">&lt;-</span></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(msa_counties) <span class="sc">+</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"gray60"</span>)</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>msa_borders <span class="sc">+</span></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(msa_crashes) <span class="sc">+</span></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>)</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>Wait a moment: did you see spot the warning up there? 👆🏼 It said: "Warning in sf::st_is_longlat(shp2): bounding box has potentially an invalid value range for longlat data."</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>Where is that coming from? Let's take a quick look at the data using the base <span class="in">`summary()`</span> function:</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msa_crashes)</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>☝️ Hint: look at the range of the latitude and longitude columns.</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>Did you spot the issue? I can use filter to track down the problem:</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>  msa_crashes,</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>  longitud <span class="sc">&gt;</span> <span class="dv">180</span> <span class="sc">|</span> latitude <span class="sc">&gt;</span> <span class="dv">90</span> <span class="sc">|</span> longitud <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">180</span> <span class="sc">|</span> latitude <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">90</span></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>To fix this issue, we need to crop the data to exclude outlying invalid coordinates. Cropping is one of a few geometry operations supported by the sf package. Let's dig in.</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a><span class="fu">## Geometry operations</span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cropping and transforming data</span></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>How can I use <span class="in">`st_crop()`</span> to exclude those incorrectly located crashes? <span class="in">`st_crop()`</span> takes two parameters:</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`x`</span>: A <span class="in">`sf`</span> or <span class="in">`sfc`</span> object that you want to *crop*</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`y`</span>: A <span class="in">`sf`</span>, <span class="in">`sfc`</span>, or <span class="in">`bbox`</span> object (or numeric x and y min/max values) that you want to crop *to*</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>This pattern of an <span class="in">`x`</span> and <span class="in">`y`</span> parameter is common across all the geometry operations although, for at least some, the second parameter is optional.</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>🤔 What parameters do you need to crop <span class="in">`msa_crashes`</span>?</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="co"># msa_crashes &lt;- st_crop()</span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>Oops. Did you get an error?</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>Here is the catch: both objects need to use the same coordinate reference system for spatial transformation functions to work. To do this we need to know what coordinate reference system <span class="in">`msa_crashes`</span> is using.</span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`st_crs()`</span> to check:</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(msa_crashes)</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also use st_crs() to get a Spatial Reference identifier (srid) for a coordinate reference system</span></span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a><span class="co"># st_crs(msa_crashes)$srid</span></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>Then we need to use the <span class="in">`st_transform()`</span> function to change to coordinate reference system of <span class="in">`msa_counties`</span>. The first parameter of <span class="in">`st_transform()`</span> is always the sf or sfc object to transform but the second parameter can be a number, a character, or the output from the <span class="in">`st_crs()`</span> function. For example, both of these calls transform <span class="in">`msa_counties`</span> to the <span class="co">[</span><span class="ot">Pseudo-Mercator</span><span class="co">](https://epsg.io/3857)</span> coordinate reference system used by Google Maps, OpenStreetMap, and other web maps:</span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a><span class="fu">st_transform</span>(msa_counties, <span class="dv">3857</span>)</span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a><span class="fu">st_transform</span>(msa_counties, <span class="st">"EPSG:3857"</span>)</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>🤔 Now it is your turn to transform <span class="in">`msa_counties`</span>. Fill in the missing parameters:</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="co"># msa_counties &lt;- st_transform()</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a>Finally, you can crop <span class="in">`msa_crashes`</span> the way you wanted:</span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite msa_crashes w/ cropped data</span></span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>msa_crashes <span class="ot">&lt;-</span> <span class="fu">st_crop</span>(msa_crashes, msa_counties)</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>OK. Let's map the cropped <span class="in">`msa_crashes`</span> data:</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Map crashes in the Baltimore metro area"</span></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>msa_borders <span class="sc">+</span></span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(msa_crashes) <span class="sc">+</span></span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>Take a moment and compare this map with a map of <span class="in">`md_crashes`</span> (which also needs to be cropped). Remember, tmap uses the bounding box of the first sf object passed to <span class="in">`tm_shape()`</span> to set the plot area.</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>md_counties <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(md_counties, <span class="fu">st_crs</span>(md_crashes))</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop md_crashes also</span></span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>md_crashes <span class="ot">&lt;-</span> <span class="fu">st_crop</span>(md_crashes, md_counties)</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>msa_borders <span class="sc">+</span></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(md_crashes) <span class="sc">+</span></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>Do you notice the difference between the two maps?</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>Imagine we didn't have couldn't use a county attribute to filter <span class="in">`msa_crashes`</span> from <span class="in">`md_crashes`</span>. How could we get data that is more like the first map?</span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a><span class="fu">### Getting the intersection or difference between pairs of simple features</span></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>Let's try out <span class="in">`st_intersection()`</span>. Like <span class="in">`st_crop()`</span>, this function takes two parameters but works a more like a cookie cutter---trimming the features of the first parameter to the boundary of the second parameter.</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>For example, I can trim <span class="in">`md_crashes`</span> to the boundary of Baltimore City.</span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>md_counties <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(md_counties, <span class="fu">st_crs</span>(md_crashes))</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>msa_counties <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(msa_counties, <span class="fu">st_crs</span>(md_crashes))</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>baltimore_city <span class="ot">&lt;-</span> msa_counties[<span class="dv">7</span>, ]</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>baltimore_crashes <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(md_crashes, baltimore_city)</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a>The function did a little more than just exclude the crashes outside Baltimore City. The names and attributes for any intersecting features from the second parameter have been joined to the features from the first parameter. You can actually get the same result using the <span class="in">`st_join()`</span> function when <span class="in">`left = FALSE`</span>:</span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>baltimore_crashes_join <span class="ot">&lt;-</span> <span class="fu">st_join</span>(md_crashes, baltimore_city, <span class="at">left =</span> <span class="cn">FALSE</span>, <span class="at">join =</span> st_intersects)</span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a><span class="co"># all.equal tests if two objects are (nearly) equal</span></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(baltimore_crashes, baltimore_crashes_join)</span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a><span class="in">`st_difference()`</span> works more like an eraser---selectively removing a specific area.</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>crashes_outside_baltimore <span class="ot">&lt;-</span> <span class="fu">st_difference</span>(md_crashes, baltimore_city)</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>I can map the data to take a look at the results:</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Map crashes in and outside of Baltimore city"</span></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>msa_borders <span class="sc">+</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(baltimore_crashes) <span class="sc">+</span></span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(crashes_outside_baltimore) <span class="sc">+</span></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a>🤔 Now, your turn. Can you use <span class="in">`st_intersection()`</span> to trim the crash data to Anne Arundel County?</span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a><span class="co"># anne_arundel_crashes &lt;-</span></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a>🤔 Can you map the Anne Arundel County crashes over top of a crash map for the full state?</span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a><span class="co"># md_borders +</span></span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a><span class="co">#   tm_shape(anne_arundel_crashes) +</span></span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a><span class="co">#   tm_dots()</span></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>🤔 Bonus question: can you figure out how many fatalities occurred in Anne Arundel County? Remember, the number of fatalities may not be the same as fatal crashes. Try using the <span class="in">`nrow()`</span> and <span class="in">`sum()`</span> functions to determine these numbers.</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>If you the intersection worked as expected, you should find **50 crashes** and **50 fatalities**.</span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a><span class="fu">## Geometric operations</span></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>OK. Let's try something different. Remember those highways? The data covers the entire U.S. but we just need the highways for Maryland.</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a>This time, I'll use the <span class="in">`st_filter()`</span> function with the default <span class="in">`st_intersects()`</span> predicate (we will come back to predicate functions at the end):</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>us_highways <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(us_highways, <span class="fu">st_crs</span>(md_crashes))</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a>md_highways <span class="ot">&lt;-</span> <span class="fu">st_filter</span>(us_highways, md_counties, <span class="at">.predicate =</span> st_intersects)</span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>As usual, a map is helpful to make sure this worked the way I expected:</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Map Maryland Highways"</span></span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a>md_borders <span class="sc">+</span></span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(md_highways) <span class="sc">+</span></span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">"darkgreen"</span>)</span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a>Now that we have highways, could we use <span class="in">`st_filter()`</span> to get highway crashes? Give it a try:</span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a><span class="fu">st_filter</span>(md_crashes, md_highways)</span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a>Well, that didn't work. The highways are a LINESTRING feature so it isn't the most effective spatial filter. Using <span class="in">`st_buffer()`</span> we can add a little space around each highway and try again.</span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a>How does <span class="in">`st_buffer()`</span> work? Using the <span class="in">`dist`</span> (short dor distance) parameter you can add space around a point, linestring, or polygon.</span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a>::: {.callout-important appearance="simple"}</span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a>This can get a little complicated depending on your coordinate reference system. When using the <span class="co">[</span><span class="ot">GEOS library</span><span class="co">](https://libgeos.org/)</span>, the units for <span class="in">`dist`</span> are degrees for geometric coordinate reference systems (e.g. EPSG:4326) or the system's native units (most often feet or meters) for projected coordinate reference systems. But, when you are using the <span class="co">[</span><span class="ot">s2geometry library</span><span class="co">](https://s2geometry.io/)</span>, <span class="in">`dist`</span> is passed to the <span class="in">`s2::s2_buffer_cells()`</span> function where the units are determined by the units used by the <span class="in">`radius`</span> parameter (which defaults to meters). It can be helpful to use the <span class="in">`units::set_units()`</span> function that makes it easier to set the buffer in whatever distance you like and then convert to the needed units.</span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a>For this exercise, let's convert our data projected CRS so we can use the version of <span class="in">`st_buffer()`</span> that works with GEOS.</span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Transform data to a projected CRS"</span></span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>md_crashes <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(md_crashes, <span class="dv">3857</span>)</span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>md_counties <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(md_counties, <span class="dv">3857</span>)</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>msa_crashes <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(msa_crashes, <span class="dv">3857</span>)</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>msa_counties <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(msa_counties, <span class="dv">3857</span>)</span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>md_highways <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(md_highways, <span class="dv">3857</span>)</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>Now, I can add a buffer:</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Buffer Maryland highways"</span></span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>md_highways_quartermi <span class="ot">&lt;-</span></span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(</span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a>    md_highways,</span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist =</span> <span class="fl">402.336</span> <span class="co"># quarter-mile in m</span></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>md_highways_halfmi <span class="ot">&lt;-</span></span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a>    md_highways,</span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist =</span> units<span class="sc">::</span><span class="fu">set_units</span>(<span class="fl">0.5</span>, <span class="st">"mi"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>      units<span class="sc">::</span><span class="fu">set_units</span>(<span class="st">"m"</span>)</span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a>I'll map the data to show that it works (using Baltimore County to set the map bounding box so it easier to see the difference between the two buffers).</span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Map bufferred Maryland highways"</span></span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(msa_counties, <span class="at">bbox =</span> msa_counties[<span class="dv">7</span>, ]) <span class="sc">+</span></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"gray60"</span>) <span class="sc">+</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(md_highways_quartermi) <span class="sc">+</span></span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(md_highways_halfmi) <span class="sc">+</span></span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"purple"</span>)</span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>🤔 A half mile buffer seems too large. Can you add a 250 meter buffer to the <span class="in">`md_highways`</span>?</span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a><span class="co"># md_highways_250m &lt;- st_buffer()</span></span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>Then, go back and filter crash data using <span class="in">`md_highways_250m`</span>. How many fatal crashes took place within 250 meters of a highway in Maryland? How many fatalities?</span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a><span class="co"># st_filter()</span></span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a>You should find **96 crashes** and **99 fatalities**.</span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## Confirming geometric relationships</span></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a>There is also a set of related functions called "predicates" or geometric confirmation functions that take pairs of simple feature geometry sets and return an index list or logical matrix based on the spatial relationship between the features. For example, take a look at <span class="in">`st_intersects()`</span>:</span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(msa_counties, md_counties, <span class="at">sparse =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a>What is this matrix? The function is comparing each element of x (<span class="in">`msa_counties`</span>) to each element of <span class="in">`y`</span> (<span class="in">`md_counties`</span>). We can simplify the function by using <span class="in">`st_union()`</span> on the second argument:</span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a>md_counties_union <span class="ot">&lt;-</span> <span class="fu">st_union</span>(md_counties)</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(msa_counties, md_counties_union, <span class="at">sparse =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-right">Made with <i class="fa-brands fa-r-project" aria-hidden="true"></i> and <a href="https://quarto.org/">Quarto</a><br><a href="https://www.github.com/elipousson/bldgspatialdata">View the source at <i class="fa-brands fa-github" aria-hidden="true"></i> GitHub</a></div>
  </div>
</footer>


</body></html>